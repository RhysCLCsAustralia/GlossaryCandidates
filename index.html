<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="main.css">
    <title>SimpleWriter</title>
  </head>
  <body>
    <h1>upwriter</h1>
    <div id="editor-wrapper">
      <div id="erroneous"></div>
      <div id="editor"></div>
    </div>
    <script src="words.js"></script>
    <script src="ace.min.js"></script>
    <script>
      'use strict';
      const editor = ace.edit("editor");
      const session = editor.getSession();

      session.setMode("ace/mode/upwriter");
      session.setUseWrapMode(true);
      session.setTabSize(0);
      editor.focus();

      const wrap = document.getElementById('editor-wrapper');
      const erroneous = document.getElementById('erroneous');
      const editorElement = document.getElementById('editor');

      erroneous.addEventListener('click', e => {
        if (e.target.tagName.toLowerCase() === "a") {
          editor.find(e.target.innerText);
          editor.findAll(e.target.innerText);
          editor.focus();
        }
      });

      session.on('changeMode', () => {
        session.getMode().onRecalculateAllowed(editor, d => {
          erroneous.innerHTML = d.map(w => `<a>${w}</a>`).join('');
          wrap.classList[d.length > 0 ? 'add' : 'remove']('invalid');
          editorElement.style.bottom = `${erroneous.clientHeight}px`;
        });
      });
    </script>
    <script>
      'use strict';
      const electron = require('electron');
      const ipcRenderer = electron.ipcRenderer;

      document.ondragover = document.ondrop = e => {
        e.preventDefault();
        return false;
      };

      wrap.ondragover = () => false;

      wrap.ondragleave = wrap.ondragend = () => false;

      wrap.ondrop = e => {
        e.preventDefault();
        let reader = new FileReader();
        let file = e.dataTransfer.files[0];
        reader.onload = e => editor.setValue(e.target.result);
        reader.readAsText(file);
        return false;
      };

      ipcRenderer.on('getText', (e, arg) => {
        e.returnValue = editor.getValue();
      });

      ipcRenderer.on('setText', (e, arg) => {
        editor.setValue(arg);
      });
    </script>
  </body>
</html>
